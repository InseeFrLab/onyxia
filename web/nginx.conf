# ============================================================
# Dynamic base domain extraction (per request)
# Extracts the last two labels from $host
# Example: datalab.sspcloud.fr -> sspcloud.fr
# ============================================================
map $host $base_domain {
    ~^(?<sub>.+)\.(?<domain>[^.]+\.[^.]+)$  $domain;
    default                                 $host;
}

server {
    listen 8080;

    # -------------------------
    # Gzip
    # -------------------------
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types
        text/plain text/css text/xml text/javascript
        application/javascript application/x-javascript application/xml;
    gzip_disable "MSIE [1-6]\.";

    # -------------------------
    # Root and SPA routing
    # -------------------------
    root /usr/share/nginx/html;
    index index.html;

    # Serve SPA; CSP applied in the HTML location block
    location / {
        try_files $uri $uri/ /index.html;
    }

    # -------------------------
    # MUI Icons
    # -------------------------
    location ^~ /mui-icons-material/ {
        try_files $uri =404;
        add_header 'Access-Control-Allow-Origin' '*' always;
        expires 90d;
        access_log off;
        add_header Cache-Control "public" always;
    }

    # -------------------------
    # DuckDB extensions (cache 1 year)
    # -------------------------
    location ^~ /duckdb-extensions/ {
        try_files $uri =404;
        add_header 'Access-Control-Allow-Origin' '*' always;
        expires 1y;
        access_log off;
        add_header Cache-Control "public" always;
    }

    # -------------------------
    # Custom resources
    # -------------------------

    # Do not cache Markdown
    location ~* ^/custom-resources/.*\.md$ {
        try_files $uri =404;
        add_header 'Access-Control-Allow-Origin' '*' always;
        expires -1;
        access_log off;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate" always;
    }

    # Cache all other custom resources for 1 day
    location ^~ /custom-resources/ {
        try_files $uri =404;
        add_header 'Access-Control-Allow-Origin' '*' always;
        expires 1d;
        access_log off;
        add_header Cache-Control "public" always;
    }

    # -------------------------
    # Vite hashed assets (cache 1 year)
    # -------------------------
    location ^~ /assets/ {
        try_files $uri =404;
        expires 1y;
        access_log off;
        add_header Cache-Control "public" always;
    }

    # -------------------------
    # HTML (never cached) + CSP
    # -------------------------
    location ~* \.html$ {
        try_files $uri =404;
        expires -1;
        add_header Content-Security-Policy
            "frame-src https://*.$base_domain https://$base_domain; frame-ancestors 'self'; object-src 'none'; worker-src 'none'; child-src 'none'"
            always;
    }

    # -------------------------
    # JSON / TXT (never cached)
    # -------------------------
    location ~* \.(json|txt)$ {
        try_files $uri =404;
        expires -1;
    }

    # -------------------------
    # Any other file with an extension (cache 1 day)
    # -------------------------
    location ~ ^.+\..+$ {
        try_files $uri =404;
        expires 1d;
        access_log off;
        add_header Cache-Control "public" always;
    }
}
